# Flexi-UI åŒæ‰“åŒ…å‘å¸ƒæ–¹æ¡ˆ

## æ¦‚è¿°

æœ¬æ–¹æ¡ˆæ—¨åœ¨ä¸º Flexi-UI ç»„ä»¶åº“å®ç° ESMã€CJS å’Œ UMD ä¸‰ç§æ ¼å¼çš„æ‰“åŒ…è¾“å‡ºï¼Œç¡®ä¿åœ¨ä¸åŒç¯å¢ƒä¸‹çš„å…¼å®¹æ€§å’Œæœ€ä½³æ€§èƒ½ã€‚

## å½“å‰çŠ¶æ€åˆ†æ

### å·²æœ‰é…ç½®

- âœ… å·²é…ç½® ESM å’Œ CJS åŒæ ¼å¼è¾“å‡º
- âœ… å·²å®ç°æŒ‰éœ€å¯¼å…¥çš„åŸå­åŒ–æ¨¡å—ç»“æ„
- âœ… å·²é…ç½® TypeScript ç±»å‹å£°æ˜æ–‡ä»¶ç”Ÿæˆ
- âœ… å·²å¤„ç† CSS æå–å’Œå‹ç¼©
- âœ… å·²æ’é™¤ peer dependencies

### éœ€è¦ä¼˜åŒ–çš„ç‚¹

- ğŸ”§ æ·»åŠ  UMD æ ¼å¼æ”¯æŒ
- ğŸ”§ ä¼˜åŒ– lodash-es çš„å¤„ç†æ–¹å¼
- ğŸ”§ å®Œå–„ external ä¾èµ–é…ç½®
- ğŸ”§ æ·»åŠ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

## å®æ–½æ–¹æ¡ˆ

### 1. Rollup é…ç½®ä¼˜åŒ–

#### 1.1 æ·»åŠ  UMD è¾“å‡ºæ ¼å¼

åœ¨ `rollup.config.js` çš„ output æ•°ç»„ä¸­æ·»åŠ  UMD é…ç½®ï¼š

```javascript
{
  file: 'dist/index.umd.js',
  format: 'umd',
  name: 'FlexiUI', // å…¨å±€å˜é‡å
  sourcemap: true,
  exports: 'named',
  globals: {
    'react': 'React',
    'react-dom': 'ReactDOM',
    '@emotion/react': 'EmotionReact',
    '@emotion/styled': 'EmotionStyled',
    'framer-motion': 'FramerMotion',
    'clsx': 'clsx',
    'crypto-js': 'CryptoJS',
    'lodash-es': '_'
  }
}
```

#### 1.2 ä¼˜åŒ– lodash-es å¤„ç†

ç”±äºé¡¹ç›®ä½¿ç”¨äº† `lodash-es`ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ä»¥é¿å…æ‰“åŒ…ä½“ç§¯è¿‡å¤§ï¼š

**æ–¹æ¡ˆ Aï¼šTree-shaking ä¼˜åŒ–ï¼ˆæ¨èï¼‰**

```javascript
// åœ¨ rollup.config.js ä¸­æ·»åŠ 
import { createFilter } from '@rollup/pluginutils';

// æ·»åŠ åˆ° plugins æ•°ç»„
{
  name: 'lodash-es-optimizer',
  resolveId(id) {
    if (id === 'lodash-es') {
      return { id: 'lodash-es', external: true };
    }
    // å…è®¸å…·ä½“çš„ lodash-es å‡½æ•°å¯¼å…¥
    if (id.startsWith('lodash-es/')) {
      return null; // è®©å…¶ä»–æ’ä»¶å¤„ç†
    }
  }
}
```

**æ–¹æ¡ˆ Bï¼šæ›¿æ¢ä¸ºå…·ä½“å¯¼å…¥**

```javascript
// ä½¿ç”¨ @rollup/plugin-alias æ›¿æ¢å¯¼å…¥
import alias from '@rollup/plugin-alias';

alias({
  entries: [
    {
      find: /^lodash-es$/,
      replacement: 'lodash-es/throttle',
    },
  ],
});
```

#### 1.3 å®Œå–„ external é…ç½®

```javascript
external: [
  'react',
  'react-dom',
  '@emotion/react',
  '@emotion/styled',
  'framer-motion',
  'clsx',
  'crypto-js',
  'lodash-es',
  // æ·»åŠ  lodash-es çš„å…·ä½“å‡½æ•°å¯¼å…¥
  /^lodash-es\/.*/,
];
```

### 2. Package.json é…ç½®æ›´æ–°

#### 2.1 æ·»åŠ  UMD å…¥å£

```json
{
  "main": "dist/index.cjs.js",
  "module": "dist/index.esm.js",
  "umd": "dist/index.umd.js",
  "types": "dist/types/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/types/index.d.ts",
      "import": "./dist/index.esm.js",
      "require": "./dist/index.cjs.js",
      "umd": "./dist/index.umd.js"
    }
    // ... å…¶ä»–å¯¼å‡ºä¿æŒä¸å˜
  }
}
```

#### 2.2 ä¼˜åŒ–æ„å»ºè„šæœ¬

```json
{
  "scripts": {
    "build:lib": "rollup -c && pnpm run build:types",
    "build:lib:dev": "rollup -c --environment NODE_ENV:development",
    "build:lib:prod": "rollup -c --environment NODE_ENV:production",
    "build:analyze": "rollup -c --environment ANALYZE:true"
  }
}
```

### 3. ç¯å¢ƒå˜é‡é…ç½®

#### 3.1 å¼€å‘/ç”Ÿäº§ç¯å¢ƒåŒºåˆ†

åœ¨ `rollup.config.js` ä¸­æ·»åŠ ç¯å¢ƒåˆ¤æ–­ï¼š

```javascript
const isProduction = process.env.NODE_ENV === 'production';
const shouldAnalyze = process.env.ANALYZE === 'true';

// æ ¹æ®ç¯å¢ƒè°ƒæ•´æ’ä»¶é…ç½®
plugins: [
  // ... å…¶ä»–æ’ä»¶
  postcss({
    extract: true,
    minimize: isProduction, // åªåœ¨ç”Ÿäº§ç¯å¢ƒå‹ç¼©
  }),
  // ç”Ÿäº§ç¯å¢ƒæ·»åŠ å‹ç¼©æ’ä»¶
  ...(isProduction
    ? [
        terser({
          compress: {
            drop_console: true,
            drop_debugger: true,
          },
        }),
      ]
    : []),
  // åˆ†ææ¨¡å¼æ·»åŠ  bundle analyzer
  ...(shouldAnalyze
    ? [
        bundleAnalyzer({
          openAnalyzer: false,
          analyzerMode: 'static',
          reportFilename: 'bundle-report.html',
        }),
      ]
    : []),
];
```

### 4. ä¾èµ–ç®¡ç†ä¼˜åŒ–

#### 4.1 æ·»åŠ å¿…è¦çš„å¼€å‘ä¾èµ–

```bash
pnpm add -D @rollup/plugin-terser @rollup/plugin-alias rollup-plugin-bundle-analyzer
```

#### 4.2 Peer Dependencies å£°æ˜

åœ¨ `package.json` ä¸­ç¡®ä¿æ­£ç¡®å£°æ˜ï¼š

```json
{
  "peerDependencies": {
    "react": ">=18.0.0",
    "react-dom": ">=18.0.0",
    "@emotion/react": ">=11.0.0",
    "@emotion/styled": ">=11.0.0"
  },
  "peerDependenciesMeta": {
    "@emotion/react": {
      "optional": false
    },
    "@emotion/styled": {
      "optional": false
    }
  }
}
```

### 5. ç±»å‹å£°æ˜ä¼˜åŒ–

#### 5.1 ç¡®ä¿ç±»å‹æ–‡ä»¶æ­£ç¡®ç”Ÿæˆ

åœ¨ `tsconfig.lib.json` ä¸­ï¼š

```json
{
  "extends": "./tsconfig.app.json",
  "compilerOptions": {
    "declaration": true,
    "declarationDir": "./dist/types",
    "emitDeclarationOnly": true,
    "allowImportingTsExtensions": false
  },
  "include": ["src/**/*"],
  "exclude": [
    "src/**/*.test.*",
    "src/**/*.stories.*",
    "src/examples/**",
    "src/main.tsx",
    "src/App.tsx"
  ]
}
```

### 6. è´¨é‡ä¿è¯

#### 6.1 æ„å»ºéªŒè¯è„šæœ¬

åˆ›å»º `scripts/verify-build.js`ï¼š

```javascript
import { readFileSync, existsSync } from 'fs';
import { resolve } from 'path';

const requiredFiles = [
  'dist/index.cjs.js',
  'dist/index.esm.js',
  'dist/index.umd.js',
  'dist/types/index.d.ts',
];

console.log('ğŸ” éªŒè¯æ„å»ºäº§ç‰©...');

let allValid = true;

requiredFiles.forEach(file => {
  if (existsSync(file)) {
    const stats = readFileSync(file, 'utf8');
    console.log(`âœ… ${file} (${(stats.length / 1024).toFixed(2)}KB)`);
  } else {
    console.log(`âŒ ${file} - æ–‡ä»¶ä¸å­˜åœ¨`);
    allValid = false;
  }
});

if (allValid) {
  console.log('ğŸ‰ æ‰€æœ‰æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡ï¼');
} else {
  console.log('ğŸ’¥ æ„å»ºéªŒè¯å¤±è´¥ï¼');
  process.exit(1);
}
```

#### 6.2 æ·»åŠ éªŒè¯è„šæœ¬åˆ° package.json

```json
{
  "scripts": {
    "verify:build": "node scripts/verify-build.js",
    "prepublishOnly": "pnpm run build:lib && pnpm run verify:build"
  }
}
```

## ä½¿ç”¨åœºæ™¯

### ESM (æ¨è)

```javascript
// ç°ä»£æ‰“åŒ…å·¥å…· (Vite, Webpack 5+, Rollup)
import { Button, DataTable } from '@daomu/flexi-ui';

// æŒ‰éœ€å¯¼å…¥
import { Button } from '@daomu/flexi-ui/Button';
import { useTheme } from '@daomu/flexi-ui/hooks/useTheme';
```

### CJS

```javascript
// Node.js æˆ–ä¼ ç»Ÿæ‰“åŒ…å·¥å…·
const { Button, DataTable } = require('@daomu/flexi-ui');

// æŒ‰éœ€å¯¼å…¥
const { Button } = require('@daomu/flexi-ui/Button');
```

### UMD

```html
<!-- ç›´æ¥åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@daomu/flexi-ui/dist/index.umd.js"></script>
<script>
  const { Button, DataTable } = FlexiUI;
</script>
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. Tree-shaking å‹å¥½

- ä½¿ç”¨ ES modules è¯­æ³•
- é¿å…é»˜è®¤å¯¼å‡ºçš„å‰¯ä½œç”¨
- ç¡®ä¿ `sideEffects` å­—æ®µæ­£ç¡®é…ç½®

### 2. åŒ…ä½“ç§¯ä¼˜åŒ–

- lodash-es æŒ‰éœ€å¯¼å…¥
- CSS æŒ‰éœ€åŠ è½½
- ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½

### 3. ç¼“å­˜ç­–ç•¥

- ç¨³å®šçš„æ–‡ä»¶åï¼ˆé¿å…ä¸å¿…è¦çš„ç¼“å­˜å¤±æ•ˆï¼‰
- åˆç†çš„ chunk åˆ†å‰²

## å‘å¸ƒæµç¨‹

1. **å¼€å‘é˜¶æ®µ**ï¼š`pnpm run build:lib:dev`
2. **æµ‹è¯•éªŒè¯**ï¼š`pnpm run verify:build`
3. **ç”Ÿäº§æ„å»º**ï¼š`pnpm run build:lib:prod`
4. **å‘å¸ƒå‰æ£€æŸ¥**ï¼š`pnpm run prepublishOnly`
5. **å‘å¸ƒ**ï¼š`pnpm publish`

## å…¼å®¹æ€§è¯´æ˜

- **ESM**: ç°ä»£æµè§ˆå™¨ã€Node.js 14+ã€ç°ä»£æ‰“åŒ…å·¥å…·
- **CJS**: Node.js æ‰€æœ‰ç‰ˆæœ¬ã€ä¼ ç»Ÿæ‰“åŒ…å·¥å…·
- **UMD**: æ‰€æœ‰æµè§ˆå™¨ç¯å¢ƒã€CDN ä½¿ç”¨

## æ³¨æ„äº‹é¡¹

1. **lodash-es å¤„ç†**ï¼šç¡®ä¿åªæ‰“åŒ…ä½¿ç”¨åˆ°çš„å‡½æ•°ï¼Œé¿å…æ•´ä¸ªåº“è¢«åŒ…å«
2. **Peer Dependencies**ï¼šç¡®ä¿ä½¿ç”¨æ–¹å®‰è£…äº†å¿…è¦çš„ä¾èµ–
3. **ç±»å‹å£°æ˜**ï¼šç¡®ä¿ TypeScript ç”¨æˆ·æœ‰å®Œæ•´çš„ç±»å‹æ”¯æŒ
4. **CSS å¤„ç†**ï¼šç¡®ä¿æ ·å¼æ–‡ä»¶æ­£ç¡®æå–å’ŒåŠ è½½
5. **ç‰ˆæœ¬å…¼å®¹**ï¼šä¿æŒå‘åå…¼å®¹æ€§ï¼Œéµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬

## åç»­ä¼˜åŒ–æ–¹å‘

1. **å¾®å‰ç«¯æ”¯æŒ**ï¼šè€ƒè™‘ Module Federation å…¼å®¹æ€§
2. **CDN ä¼˜åŒ–**ï¼šæä¾› CDN å‹å¥½çš„æ„å»ºäº§ç‰©
3. **æŒ‰éœ€åŠ è½½**ï¼šå®ç°æ›´ç»†ç²’åº¦çš„ä»£ç åˆ†å‰²
4. **æ€§èƒ½ç›‘æ§**ï¼šæ·»åŠ æ„å»ºäº§ç‰©å¤§å°ç›‘æ§å’Œå‘Šè­¦
